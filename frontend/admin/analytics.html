<!DOCTYPE html>
<html>
<head>
    <title>Transit Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Transit Analytics</h1>
<canvas id="tagChart" width="600" height="300"></canvas>
<canvas id="agencyChart" width="600" height="300"></canvas>
<canvas id="timeChart" width="600" height="300"></canvas>

<script>
    async function fetchData() {
        const res = await fetch('/admin/reports');
        return await res.json();
    }

    function countBy(array, key) {
        const counts = {};
        array.forEach(item => {
            if (Array.isArray(item[key])) {
                item[key].forEach(tag => {
                    counts[tag] = (counts[tag] || 0) + 1;
                });
            } else {
                const val = item[key];
                if (val) counts[val] = (counts[val] || 0) + 1;
            }
        });
        return counts;
    }

    function groupByDate(data) {
        const counts = {};
        data.forEach(r => {
            const date = new Date(r.created_at).toISOString().slice(0, 10);
            counts[date] = (counts[date] || 0) + 1;
        });
        return counts;
    }

    function drawChart(ctxId, label, dataMap) {
        const labels = Object.keys(dataMap);
        const data = Object.values(dataMap);

        new Chart(document.getElementById(ctxId), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label,
                    data,
                    backgroundColor: 'steelblue'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    fetchData().then(reports => {
        drawChart('tagChart', 'Tag Frequency', countBy(reports, 'tags'));
        drawChart('agencyChart', 'Agency Reports', countBy(reports, 'agency'));
        drawChart('timeChart', 'Reports Over Time', groupByDate(reports));
    });
</script>
</body>
</html>
